\documentclass[xcolor=table,aspectratio=169]{beamer}
\usepackage{beamerthemesplit}
\usepackage{wrapfig}
\usetheme{SPBU}
\usepackage{pdfpages}
\usepackage{amsmath}
\usepackage{cmap}
\usepackage[T2A]{fontenc}
\usepackage[utf8]{inputenc}
\usepackage[english]{babel}
\usepackage{indentfirst}
\usepackage{amsmath}
\usepackage{tikz}
\usepackage{multirow}
\usepackage[noend]{algpseudocode}
\usepackage{algorithm}
\usepackage{algorithmicx}
\usepackage{fancyvrb}
\usetikzlibrary{calc}
\usetikzlibrary{shapes,arrows}
\usetikzlibrary{arrows,automata}
\usetikzlibrary{positioning}


\usepackage{appendix}

\usepackage{appendixnumberbeamer}

%usepackage{fancyvrb}
%\usepackage{minted}
%\usepackage{verbments}
\usepackage{fontawesome}

%for [[]]
\usepackage{stmaryrd}

%code highlight
\usepackage{listings}
\usepackage{xcolor}


\usepackage{minted}
% center listings
\RecustomVerbatimEnvironment{Verbatim}{BVerbatim}{}

\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

% lstlisting Haskell style (inspired from a file of Assia Mahboubi)
%
\lstdefinelanguage{Haskell}{ 
%
% Anything betweeen $ becomes LaTeX math mode
mathescape=true,
%
% Comments may or not include Latex commands
texcl=false, 
%
morekeywords=[1]{class, instance},
%
morekeywords=[2]{where},
%
morekeywords=[3]{Maybe},
%
morekeywords=[4]{main},
%
morekeywords=[6]{do, last, first, try, idtac, repeat},
%
% Comments delimiters, we do turn this off for the manual
morecomment=[s]{(*}{*)},
%
% Spaces are not displayed as a special character
showstringspaces=false,
%
% String delimiters
morestring=[b]",
morestring=[d],
%
% Size of tabulations
tabsize=3,
%
% Enables ASCII chars 128 to 255
extendedchars=false,
%
% Case sensitivity
sensitive=true,
%
% Automatic breaking of long lines
breaklines=false,
%
% Default style fors listings
basicstyle=\small,
%
% Position of captions is bottom
captionpos=b,
%
% flexible columns
columns=[l]flexible,
%
% Style for (listings') identifiers
identifierstyle={\ttfamily\color{black}},
% Style for declaration keywords
keywordstyle=[1]{\ttfamily\color{codepurple}},
% Style for gallina keywords
keywordstyle=[2]{\ttfamily\color{codepurple}},
% Style for sorts keywords
keywordstyle=[3]{\ttfamily\color{codepurple}},
% Style for tactics keywords
keywordstyle=[4]{\ttfamily\color{codepurple}},
% Style for terminators keywords
keywordstyle=[5]{\ttfamily\color{codepurple}},
%Style for iterators
%keywordstyle=[6]{\ttfamily\color{dkpink}},
% Style for strings
stringstyle=\ttfamily,
% Style for comments
commentstyle={\ttfamily\color{codegray}},
%
%moredelim=**[is][\ttfamily\color{red}]{/&}{&/},
literate=
    {->}{{$\rightarrow\;$}}1
    {=>}{{$\Rightarrow\;$}}1
    {++}{{\code{++}}}1
    {~}{{\ }}1
    {\\dollar}{{$\$$\;}}1
%
}[keywords,comments,strings]

\lstnewenvironment{haskell}{\lstset{language=Haskell}}{}

% pour inliner dans le texte
\def\hasqel{\lstinline[language=Haskell, basicstyle=\small]}
% pour inliner dans les tableaux / displaymath...
\def\haskels{\lstinline[language=Haskell, basicstyle=\scriptsize]}

%%% Local Variables: 
%%% mode: latex
%%% Local IspellDict: british
%%% TeX-master: "main.tex"
%%% End: 

 

\usepackage{tabularx}
\newcolumntype{Y}{>{\raggedleft\arraybackslash}X}

\renewcommand{\thealgorithm}{}

\newtheorem{mytheorem}{Theorem}
\renewcommand{\thealgorithm}{}

\newcommand{\tikzmark}[1]{\tikz[overlay,remember picture] \node (#1) {};}
\def\Put(#1,#2)#3{\leavevmode\makebox(0,0){\put(#1,#2){#3}}}

\newcommand{\ltz}{$< 1$}


% color for tables
\usepackage{colortbl}
% define new colors
\definecolor{LightRed}{RGB}{204, 230, 255}
\definecolor{LightBlue}{RGB}{140,186,252}

% \definecolor{kellygreen}{rgb}{0.3, 0.73, 0.09}
% \definecolor{kellygreen}{rgb}{0.56, 0.93, 0.56}
\definecolor{kellygreen}{rgb}{0.47, 0.87, 0.47}
% \definecolor{mediumcandyapplered}{rgb}{0.89, 0.02, 0.17}
\definecolor{mediumcandyapplered}{rgb}{1.0, 0.41, 0.38}
\definecolor{forestgreen(web)}{rgb}{0.13, 0.55, 0.13}
% \definecolor{darktangerine}{rgb}{1.0, 0.66, 0.07}
\definecolor{darktangerine}{rgb}{1.0, 0.7, 0.28}


% use the colortbl package to define a new column
\newcolumntype{a}{>{\columncolor{LightRed}}c}

\tikzset{
    state/.style={
           rectangle,
           rounded corners,
           draw=black, very thick,
           minimum height=2em,
           inner sep=2pt,
           text centered,
           },
}

\beamertemplatenavigationsymbolsempty


\title[]{Экспериментальное исследование
применимости дистилляции и
специализированного аппаратного
обеспечения для обработки разреженных
данных}
% То, что в квадратных скобках, отображается в левом нижнем углу.
\institute[СПбГУ]{
% JetBrains Research, Programming Languages and Tools Lab  \\
% Санкт-Петербургский государственный университет
Санкт-Петербург 2022
}

% То, что в квадратных скобках, отображается в левом нижнем углу.
% \author[Алекей Тюрин]{Алексей Тюрин}

\author[Алексей Тюрин]{{{\bfseries Автор:} Тюрин Алексей Валерьевич}\\
  \and  
	{\scriptsize{\bfseries Научный руководитель:} к.ф-м.н., доцент кафедры информатики С.\,В.\,Григорьев}\\
	{\scriptsize{\bfseries Научный консультант:} к.ф-м.н., доцент кафедры СП Д.\,А.\,Березун}\\
	{\scriptsize{\bfseries Рецензент:} инженер-программист, ООО <<Ланит-Терком>> О.\,В.\,Медведев
}
\\}

\date{07.06.2022}

\begin{document}
{
\begin{frame}[fragile, plain]
  \begin{tabular}{p{2cm}p{9cm}p{2cm}}
  \begin{center}
    %   \includegraphics[height=1.5cm]{pictures/jetbrainsResearch.pdf}
    \end{center}
    &
    \begin{center}
    Санкт-Петербургский государственный университет\\
    Программная инженерия
    \end{center}
    &
    \begin{flushright}
      \includegraphics[height=1.5cm]{pictures/SPbGU_Logo.png}
    \end{flushright}
  \end{tabular}
  \titlepage
\end{frame}
}
\begin{frame}[fragile]
    \frametitle{Разреженная линейная алгебра}
    \begin{itemize}
      \item Часто данные содержат много <<нулевых>> элементов
      \vfill
      \begin{itemize}
      \vfill
          \item Неэффективно хранить эти элементы в явном виде
        %   to store such values explicitly and perform operations on them since the result is known beforehand
          \vfill
          \item В случае линейной алгебры данные представлены матрицами
          \vfill
          \item Чтобы преодолеть неэффективность хранения таких элементов, матрицы представляются в виде разреженных структур
          \vfill
          \begin{itemize}
              \item Хранят только нужные элементы, вводя дополнительные указатели  
          \end{itemize}
      \end{itemize}
      \vfill
    \item Подход широко используется
      \begin{itemize}
      \vfill
          \item Анализ графов
          \vfill
          \item Вычислительная биология
          \vfill
          \item Машинное обучение
          \vfill
          \item \ldots
      \end{itemize}
      \vfill
      \item \emph{GraphBLAS} спецификация 
    %   описывает необходимые для реализации блоки, из которых можно собирать алгоритмы в терминах разреженной линейной алгебры 
    \end{itemize}
  \end{frame}

\begin{frame}[c,fragile] \frametitle{GraphBLAS}


% \begin{minipage}{1\textwidth}
% \centering
% \begin{minted}{python}
% #Sparse algebra BFS:
% #times: if (A[i,j] != 0) A[i,j] × q(k) = k
% #       else 0
% #plus : any(x,y) = x or y randomly

% q = [source]; 
% parent = [0 for i in range(n)]; 
% parent[source] = source;

% while (q not empty)
%     #masked matrix vector multiplication
%     q<¬parent> = A*q #mask could be inverted
%     #masked assignment
%     parent<q> = q
% \end{minted}
    

% \end{minipage}

% Efficient compilation of sparse linear algebra programs into specialized hardware environment ? 

% Потом, кажется, надо придумать какую-то мотивацию для использования функциональных языков

\begin{itemize}
    \item Спецификация определяет блоки линейной алгебры для описания алгоритмов анализа графов
    \vfill
    \begin{itemize}
        \item Использует в реализациях разреженные матрицы
    \end{itemize}
    % Standard, that defines sparse linear algebra building blocks to build graph analysis algorithms
    \vfill
    \item Оптимизированные блоки $\to$ оптимизированные алгоритмы
    \vfill
    \item Предлагает несколько оптимизаций
    \vfill
    \begin{itemize}
        % \item Heuristic-driven load-balancing
        % \vfill
        \item \textcolor{codepurple}{Fusion оптимизации}
    \end{itemize}
\end{itemize}

\end{frame}

\begin{frame}[fragile]{Fusion оптимизации}

\begin{itemize}
            \item Устраняют промежуточные структуры данных
            \vfill
            \begin{itemize}
                \item Связуют производителей и потребителей
                \vfill
                \item \texttt{append (append xs ys) zs}
                \vfill
                \item Часто возникают в приложениях с разреженной линейной алгеброй
            \end{itemize}
            \vfill
            \item Ad-hoc реализации
            \vfill
            \begin{itemize}
                \item Реализованы для определенных операций вручную, например, для применения маски
                \vfill
                \item Основаны на правилах переписывания
                % , требующих определенных свойств вроде коммутативности и ассоциативности или выражения алгоритмов в виде композиции комбинаторов
                \vfill
                \item Дублирование производителей, слияние потребителей, слияние результатов производителей (XLA)
                % Based on rewrite rules that require properties like commutativity, associativity, etc., which is not often the case in practice
                \vfill
                \item Автоматический fusion затруднителен из-за адресной арифметики 
                % страдает от индексирования, которое привносится разреженностью
                % Automatic fusion suffers from indexing induced by sparsity
            \end{itemize}
        \end{itemize}
    
\end{frame}


% \begin{frame}[fragile]{Fusion оптимизации}

% \begin{itemize}
%             \item Устраняют промежуточные структуры данных
%             \vfill
%             \item Ad-hoc реализации
%             \vfill
%             \begin{itemize}
%                 \item Реализованы для определенных операций вручную, например, для применения маски
%                 \vfill
%                 \item Основаны на правилах переписывания, которые требуют определенных свойств вроде коммутативности и ассоциативности или выражения алгоритмов в виде композиции комбинаторов 
%                 % Based on rewrite rules that require properties like commutativity, associativity, etc., which is not often the case in practice
%                 \vfill
%                 \item Автоматический fusion страдает от индексирования, которое привносится разреженностью
%                 % Automatic fusion suffers from indexing induced by sparsity
%             \end{itemize}
%         \end{itemize}
    
% \end{frame}

\begin{frame}[fragile] \frametitle{Дистилляция}
%     \begin{itemize}
%         \item Обобщение суперкомпиляции
%         \vfill
%         \item Представляет все возможные трассы исполнения программы конечным графом
%         \vfill
%         \item Предоставляет \textcolor{forestgreen(web)}{fusion}
%         % \vfill
%         % \begin{itemize}
%         %     \item Делает транзитивное замыкание графа
%         %     \vfill
%         % \end{itemize}
%         % \item Ещё несколько полезных свойств
%         % \vfill
%         % \begin{itemize}
%         %     \item Распространение позитивной информации
%         %     \vfill
%         %     \item Специализация
%         % \end{itemize}
%     \end{itemize}


\begin{columns}
    \begin{column}{6cm}
\begin{lstlisting}[language=Haskell]
append (append xs ys) zs where

  append xs ys = case xs of
    [] -> ys
    (x:xs') -> x : (append xs' ys)
\end{lstlisting}
    \end{column}
    \hfill
    
\begin{column}{4cm}

\includegraphics[width=\textwidth]{pictures/test.drawio.pdf}

\end{column}
    
    \hfill
\begin{column}{6cm}
\begin{lstlisting}[language=Haskell]
f xs ys zs where

 f xs ys zs = case xs of
    [] -> case ys of
       [] -> zs
       y':ys' -> y': (g ys') where
          
         g ys = case ys of
            [] -> zs
            y':ys' -> y':(g ys')
    x':xs' -> x':(f xs' ys zs)
\end{lstlisting}
\end{column}
      

\end{columns}

\begin{itemize}
    \item Обобщение суперкомпиляции
    \vfill
    \item Представляет все возможные трассы исполнения программы конечным графом
    \vfill
    \item Предоставляет \textcolor{codepurple}{fusion}
\end{itemize}

\end{frame}
  
  
\begin{frame}[fragile] \frametitle{Специализированное аппаратное обеспечение}
    \begin{itemize}
        \item Устройства общего назначения (CPU, GPU) неэффективно используются в разреженных приложениях
        % General purpose devices are inefficient for sparse applications
        \vfill
        \begin{itemize}
            \item Малая загруженность
            % \vfill
            % \item Высокое потребление энергии
            \vfill
        \end{itemize}
        \item Специализированное аппаратное обеспечение начинает широко использоваться в разреженных приложениях
        \vfill
        \item Обращение к памяти остаётся узким местом
        % \item Потребление энегрии доминируется доступом к внешней памяти 
        % Power consumption is dominated by external memory accesses
        \vfill
        \item \textcolor{codepurple}{Fusion уменьшает число доступов к памяти}
    \end{itemize}
  \end{frame}  

%   \begin{frame}[fragile] \frametitle{The ultimate purpose}
%   \begin{itemize}
%       \item Типичные CPU и GPU слабо загружаются при выполнении разреженных операций
%       \end{itemize}
%   \begin{table}[ht]
%   \footnotesize
% \centering
% % \caption{A table without vertical lines.}
% \begin{tabular}[t]{c c c c c}
% \hline
% & MKL & cuSPARSE & CUSP\\
% & on Intel Core i7-5930K & on Titan Xp & on Titan Xp \\
% \hline
% Average GFLOPS\footnote{\tiny{Jure Leskovec and Rok Sosič. 2016. SNAP: A General-Purpose Network Analysis and Graph-Mining Library.}}\footnote{\tiny{Timothy A. Davis and Yifan Hu. 2011. The University of Florida Sparse Matrix Collection. ACM Transactions on Mathematical Software 38}} & 0.560 & 0.595&0.631\\
% Theoretical GFLOPS\footnote{\tiny{\url{https://www.pugetsystems.com/labs/hpc/Linpack-performance-Haswell-E-Core-i7-5960X-and-5930K-594}}}\footnote{\tiny{\url{https://www.techpowerup.com/gpu-specs/titan-x-pascal.c2863}}} & 289 & 343 & 343\\
% Utilization & 0.194\% & 0.173\% & 0.184\%\\
% \hline
% \end{tabular}
% \caption{CPU and GPU underutilization}
% \end{table}%
% \end{frame}


\begin{frame}[fragile] \frametitle{Цель}
%   \begin{itemize}
    %   \item cuSPARSE умножение двух разрженных матриц (roadNet-CA)
    %   \end{itemize}
    %   \begin{minipage}{0.45\linewidth}
    %   \begin{figure}
    %       \centering
    %       \includegraphics[width=\linewidth]{pictures/fig_2_bar.pdf}
    %       \caption{Производительность процессора}
    %       \label{fig:my_label}
    %   \end{figure}
    %   \end{minipage}
    %   \begin{minipage}{0.45\linewidth}
    %   \begin{figure}
    %       \centering
    %       \includegraphics[width=0.65\linewidth]{pictures/fig2-pie.pdf}
    %       \caption{Время выполнения}
    %       \label{fig:my_label}
    %   \end{figure}
    %   \end{minipage}
    
    \begin{block}{Цель}
    % Apply distillation to provide optimizations for sparse linear algebra programs eventually compiling them into specialized hardware
    Оценить, насколько целесообразно и практично использовать дистилляцию и специализированное аппаратное обеспечение для оптимизации программ с операциями разреженной линейной алгебры

    \end{block}
    \begin{itemize}
    \vfill
        \item Изучить подходы к fusion в различных системах
        \vfill
        \item Реализовать генерацию аппаратной схемы с поддержкой fusion
        \vfill
        \item Реализовать работу с памятью для схемы
        \vfill
        \item Реализовать тестовый стенд и провести эксперименты
        % \vfill
        % \item Дистилляция <<бесплатно>> предоставляет fusion для функциональных языков
        % \vfill
        % \item Функциональный язык $\to$ аппаратная схема? 
        % \vfill
        % \item Specialized hardware mitigates this loss
        % \begin{itemize}
        %     \vfill
        %     \item Extensively used for sparse applications
        %     \vfill
        %     \item More efficient than GPUs/CPUs counterparts
        % \end{itemize}
    \end{itemize}
      
\end{frame}


\begin{frame}[fragile] \frametitle{Реализация генерации аппаратной схемы с поддержкой fusion}

    \begin{itemize}
        \item Дистилляция <<бесплатно>> предоставляет fusion для функциональных языков
        \vfill
        \item Программа на функциональном языке $\to$ аппаратная схема? 
        \vfill
        \begin{itemize}
            \item Высокоуровневый синтез
            \vfill
            \item Генерация схемы по всей программе повышает отношение <<полезных>> операций относительно обращений к памяти
            \vfill
            \item Общепринятые инструменты для высокоуровнего синтеза императивны
    \end{itemize}
        
        
    \end{itemize}
      
\end{frame}

\begin{frame}[fragile]\frametitle{Используемые инструменты}

\begin{itemize}
\item Дистиллятор\footnote{\url{https://github.com/YaccConstructor/Distiller/tree/adding-tests}}
\item FHW\footnote{\url{https://github.com/sedwards-lab/fhw}} — компилятор из Haskell в System Verilog
\begin{itemize}
            \item Экспериментальный
            \vfill
            \item Произвольная рекурсия
            \vfill
            \item Параллельное и конвейеризуемое представления потока данных
            \vfill
            \item Предполагает наличие аппаратного сборщика мусора (не реализует)
            \vfill
            \item Использует External Core GHC в качестве фронтенда
            \begin{itemize}
                \item GHC > 7.6.3 не поддерживает External Core (сейчас актуальная 9.0.2)
            \end{itemize}
            \vfill
            \item Нет поддержки внешней памяти
            \vfill
            \begin{itemize}
                \item Все данные находятся в коде/схеме 
            \end{itemize}
        \end{itemize}
\end{itemize}

\end{frame}

\begin{frame}[fragile] \frametitle{Структура данных}

    \begin{itemize}
        \item Результат fusion зависит от используемого представления разреженных матриц
        \vfill
        \item Широко используемые координатные форматы (CSR, COO) не подходят
        \vfill
        \item Используется представление дерева квадрантов (в среднем в \textcolor{codepurple}{1{,}5} раза больше памяти, чем координатный формат, на используемых в работе матрицах)
    \end{itemize}
    
\vspace{1cm}

% \begin{minted}{Haskell}

%   data QTree a = QNone  
%               | QVal a 
%               | QNode (QTree a) (QTree a)
%                       (QTree a) (QTree a) 
  
%  \end{minted}
\centering

\includegraphics[width=0.8\textwidth]{pictures/qtree_horizontal.pdf}

\end{frame}


\begin{frame}[fragile] \frametitle{Диаграмма потока данных}

\centering
\includegraphics[height=0.8\textheight]{pictures/arch.drawio (4).pdf}

\end{frame}


% \begin{frame}[fragile] \frametitle{План}

%     \begin{itemize}
%         \item Заставить работать FHW
%         \vfill
%         \item Провести первые эксперименты
%         \vfill
%         \item Убрать зависимость от GHC 7.6.3
%         \vfill
%         \item Добавить поддержку внешней памяти
%         \vfill
%         \item Провести полноценные эксперименты
%     \end{itemize}
      
% \end{frame}

\begin{frame}[fragile] \frametitle{Улучшение используемых инструментов}
  \begin{itemize}
  \item Дистиллятор
    \begin{itemize}
        \item Синтаксическая трансляция в Haskell
        \vfill
        \item Удаление дублирующихся функций из резидуализированной программы
        \vfill
    \end{itemize}
    \item FHW
        \begin{itemize}
            \item Добавлена поддержка алгебраических типов данных с произвольным числом полей
            \vfill
            \item Исправлены баги
            \vfill
            \item Добавлена возможность передать аргументы в функцию \texttt{main}
            \vfill
            \begin{itemize}
                \item AXI-Stream
                \vfill
                \item Для десериализации деревьев с полностью заполненными узлами достаточно одного стека
                \vfill
                \item Вся память --- bram внутри схемы
            \end{itemize}
        \end{itemize}
      \vfill
      \item Автоматизирован процесс тестирования и бенчмаркинга
      \vfill
      \begin{itemize}
          \item Xilinx Vivado + TCL
      \end{itemize}
  \end{itemize}
\end{frame}

\begin{frame}{GHC 7.6.3}
    \begin{itemize}
        \item Используется GRIN фреймворк в качестве связующего звена между языком для дистиллятора и представления потока данных
        \vfill
        \begin{itemize}
            \item Реализован транслятор с языка \texttt{.pot} в \texttt{.grin}
        \end{itemize}
        % We use GRIN framework as a middleware between frontend language of the distiller and dataflow backend
        \vfill
        \item Предоставляет дополнительные оптимизации
        \vfill
        \item CPS и дефункционализация выражаются проще
        \vfill
        \item \textcolor{codepurple}{В данный момент heap-points-to анализ в GRIN недостаточно производителен для наших примеров\footnote{\url{https://github.com/grin-compiler/grin/issues/128}}}
    \end{itemize}
\end{frame}


\begin{frame}[fragile]\frametitle{Эксперименты}

\begin{itemize}
    \item Даёт ли дистилляция преимущества на программном и аппаратном уровнях?
    \vfill
    \item Оказываются ли сгенерированные аппаратные схемы производительнее программных реализаций?
    \vfill
    \item Какие характеристики у сгенерированных аппаратных схем?
\end{itemize}
    
\end{frame}

% \begin{frame}[fragile]\frametitle{Сравнение дистиллированных и недистиллированных аппаратных схем (небольше матрицы)}

% \begin{figure}
%     \centering
%     \includegraphics[width=\textwidth]{pictures/HardwareBenchs.pdf}
%     % \caption{Experiments for small matrices}
%     \label{fig:my_label}
% \end{figure}

% % \begin{itemize}
% %     \vfill
% %     \item Compared distilled and non-distilled programs in hardware
% % \end{itemize}
    
% \end{frame}


\begin{frame}[fragile]\frametitle{Даёт ли дистилляция преимущества на программном и аппаратном уровнях?}

\centering
\begin{table}[t]
\tiny
\centering
\begin{tabular}{|l|c|c|c|c|c|c|c|c|c|} 
\hline
\rowcolor{LightBlue}
{Функция} & \multicolumn{3}{|c|}{Размеры матриц} & Haskell & Haskell (distilled) & \multicolumn{2}{c|}{FHW} & \multicolumn{2}{c|}{FHW (distilled)}\\
% \rowcolor{LightBlue}
\hline
{} & m1 & m2 & m3 & время & время & время & время (вкл. IO) & время & время (вкл. IO)\\
\hline
\multirow{4}{6em}{\texttt{m1 + m2 + m3}} &
64 & 64 & 64 & \cellcolor{mediumcandyapplered}29 us & \cellcolor{kellygreen}20 us & \cellcolor{mediumcandyapplered}76 us & 170 us & \cellcolor{kellygreen}64 us & 158 us\\ 
{} & 128 & 128 & 128 & \cellcolor{mediumcandyapplered}94 & \cellcolor{kellygreen}79 & \cellcolor{mediumcandyapplered}146 & 476 & \cellcolor{kellygreen}134 & 469\\
{} & 256 & 256 & 256 & \cellcolor{mediumcandyapplered}123 & \cellcolor{kellygreen}103 & \cellcolor{mediumcandyapplered}202 &  681 & \cellcolor{kellygreen}168 & 662\\
{} & 512 & 512 & 512 & \cellcolor{mediumcandyapplered}219 & \cellcolor{kellygreen}143 & \cellcolor{mediumcandyapplered}474 & 1192 & \cellcolor{kellygreen}375 & 1093\\
\hline
\multirow{4}{6em}{\texttt{mask m \\\hspace{2em}(m1 + m2)}} &
64 & 64 & 64 & \cellcolor{mediumcandyapplered}10 us & \cellcolor{kellygreen}7 us & \cellcolor{mediumcandyapplered}64 us & 133 us & \cellcolor{kellygreen}46 us & 111 us\\ 
{} & 128 & 128 & 128 & \cellcolor{mediumcandyapplered}38 & \cellcolor{kellygreen}30 & \cellcolor{mediumcandyapplered}118 & 322 & \cellcolor{kellygreen}75 & 292\\
{} & 256 & 256 & 256 & \cellcolor{mediumcandyapplered}48 & \cellcolor{kellygreen}42 & \cellcolor{mediumcandyapplered}168 &  498 & \cellcolor{kellygreen}104 & 456\\
{} & 512 & 512 & 512 & \cellcolor{mediumcandyapplered}126 & \cellcolor{kellygreen}76 & \cellcolor{mediumcandyapplered}400 & 762 & \cellcolor{kellygreen}300 & 729\\
\hline
\multirow{4}{6em}{\texttt{map f \\\hspace{1.5em}(m1 + m2)}} &
64 & 64 & --- & \cellcolor{mediumcandyapplered}45 us & \cellcolor{kellygreen}37 us & \cellcolor{mediumcandyapplered}189 us & 253 us & \cellcolor{kellygreen}137 us & 202 us\\ 
{} & 128 & 128 & --- & \cellcolor{mediumcandyapplered}162 & \cellcolor{kellygreen}105 & \cellcolor{mediumcandyapplered}524 & 685 & \cellcolor{kellygreen}397 & 579\\
{} & 256 & 256 & --- & \cellcolor{mediumcandyapplered}312 & \cellcolor{kellygreen}216 & \cellcolor{mediumcandyapplered}1047 &  1360 & \cellcolor{kellygreen}680 & 986\\
{} & 512 & 512 & --- & \cellcolor{mediumcandyapplered}436 & \cellcolor{kellygreen}273 & \cellcolor{mediumcandyapplered}1346 & 1776 & \cellcolor{kellygreen}900 & 1330\\
\hline
\multirow{4}{6em}{\texttt{map f \\\hspace{2em}(kron m1\\\hspace{4.5em} m2)}} &
2 & 64 & --- & \cellcolor{mediumcandyapplered}64 us & \cellcolor{kellygreen}36 us & \cellcolor{mediumcandyapplered}212 us & 242 us & \cellcolor{kellygreen}94 us & 125 us\\ 
{} & 2 & 128 & --- & \cellcolor{mediumcandyapplered}137 & \cellcolor{kellygreen}68 & \cellcolor{mediumcandyapplered}434 & 502 & \cellcolor{kellygreen}199 & 266\\
{} & 2 & 256 & --- & \cellcolor{mediumcandyapplered}364 & \cellcolor{kellygreen}126 & \cellcolor{mediumcandyapplered}1004 &  1188 & \cellcolor{kellygreen}449 & 636\\
{} & 4 & 128 & --- & \cellcolor{mediumcandyapplered}302 & \cellcolor{kellygreen}94 & \cellcolor{mediumcandyapplered}694 & 763 & \cellcolor{kellygreen}330 & 401\\
\hline
\end{tabular}

\end{table}

\begin{itemize}
    \item До \textbf{2}-х и \textbf{3}-х раз улучшение времени работы для аппратных и программных реализаций соответственно
\end{itemize}

\end{frame}


% \begin{frame}[fragile]\frametitle{Даёт ли дистилляция преимущества на программном и аппаратном уровнях?}

% \setbeamertemplate{caption}{\insertcaption}

% \centering
% \begin{table}[h]
% \scriptsize
% \begin{minipage}{0.45\linewidth}
% \centering
% \caption{\texttt{m1 + m2 + m3}}
% \begin{tabular}{|c|c|c|c|c|c|c|} 
% \hline
% \rowcolor{LightBlue}
% \multicolumn{3}{|c|}{Размеры матриц} & \multicolumn{2}{c|}{Отношение ($\frac{FHW}{FHW_{distilled}}$)}\\
% \hline
% m1 & m2 & m3 & запси & чтения\\ 
% \hline
% 64 & 64 & 64 & 1{,}10 & 1{,}15\\ 
% 128 & 128 & 128 & 1{,}02 & 1{,}05\\
% 256 & 256 & 256 & 1{,}03 & 1{,}06\\
% 512 & 512 & 512 & 1{,}10 & 1{,}16\\
% \hline
% \end{tabular}
% \end{minipage}
% \begin{minipage}{0.45\linewidth}
% \centering
% \caption{\texttt{mask m (m1 + m2)}}
% \begin{tabular}{|c|c|c|c|c|c|c|} 
% \hline
% \rowcolor{LightBlue}
% \multicolumn{3}{|c|}{Размеры матриц} & \multicolumn{2}{c|}{Отношение ($\frac{FHW}{FHW_{distilled}}$)}\\
% \hline
% m1 & m2 & m3 & записи & чтения\\ 
% \hline
% 64 & 64 & 64 & 1{,}13 & 1{,}26\\ 
% 128 & 128 & 128 & 1{,}06 & 1{,}11\\
% 256 & 256 & 256 & 1{,}08 & 1{,}09\\
% 512 & 512 & 512 & 1{,}10 & 1{,}16\\
% \hline
% \end{tabular}
% \end{minipage}
% \vfill
% \begin{minipage}{0.45\linewidth}
% \centering
% \caption{\texttt{map f (m1 + m2)}}
% \begin{tabular}{|c|c|c|c|c|c|c|} 
% \hline
% \rowcolor{LightBlue}
% \multicolumn{3}{|c|}{Размеры матриц} & \multicolumn{2}{c|}{Отношение ($\frac{FHW}{FHW_{distilled}}$)}\\
% % \rowcolor{LightBlue}
% \hline
% m1 & m2 & m3 & записи & чтения\\ 
% \hline
% 64 & 64 & --- & 1{,}10 & 1{,}21\\ 
% 128 & 128 & --- & 1{,}07 & 1{,}14\\
% 256 & 256 & --- & 1{,}07 & 1{,}19\\
% 512 & 512 & --- & 1{,}10 & 1{,}21\\
% \hline
% \end{tabular}
% \end{minipage}
% \begin{minipage}{0.45\linewidth}
% \centering
% \caption{\texttt{map f (kron m1 m2)}}
% \begin{tabular}{|c|c|c|c|c|c|c|} 
% \hline
% \rowcolor{LightBlue}
% \multicolumn{3}{|c|}{Размеры матриц} & \multicolumn{2}{c|}{Отношение ($\frac{FHW}{FHW_{distilled}}$)}\\
% % \rowcolor{LightBlue}
% \hline
% m1 & m2 & m3 & записи & чтения\\ 
% \hline
% 2 & 64 & --- & 1{,}71 & 1{,}88\\ 
% 2 & 128 & --- & 1{,}72 & 1{,}87\\
% 2 & 256 & --- & 1{,}65 & 1{,}83\\
% 4 & 128 & --- & 1{,}81 & 1{,}91\\
% \hline
% \end{tabular}
% \end{minipage}

% \end{table}
% \end{frame}

\begin{frame}[fragile]\frametitle{Оказываются ли сгенерированные аппаратные схемы производительнее программных реализаций?}

\centering
\begin{table}[t]
\tiny
\centering
\begin{tabular}{|l|c|c|c|c|c|c|c|} 
\hline
\rowcolor{LightBlue}
{Функция} & \multicolumn{3}{|c|}{Размеры матриц} & Haskell (distilled) & \multicolumn{2}{c|}{FHW (distilled)} & {C\texttt{++}}\\
% \rowcolor{LightBlue}
\hline
{} & m1 & m2 & m3 & время & время & время (вкл. IO)& time \\ 
\hline
\multirow{4}{6em}{\texttt{m1 + m2 + m3}} &
64 & 64 & 64 & \cellcolor{darktangerine}20 us & 64 us & \cellcolor{mediumcandyapplered}158 us & \cellcolor{kellygreen}14 us\\ 
{} & 128 & 128 & 128 & \cellcolor{darktangerine}79 &134 & \cellcolor{mediumcandyapplered}469 & \cellcolor{kellygreen}30 \\
{} & 256 & 256 & 256 & \cellcolor{darktangerine}103 & 168 & \cellcolor{mediumcandyapplered}662 & \cellcolor{kellygreen}44\\
{} & 512 & 512 & 512 & \cellcolor{darktangerine}143 & 375 & \cellcolor{mediumcandyapplered} 1093 & \cellcolor{kellygreen}49\\
\hline
\multirow{4}{6em}{\texttt{mask m \\\hspace{2em}(m1 + m2)}} &
64 & 64 & 64 & \cellcolor{kellygreen}7 us & 46 us & \cellcolor{mediumcandyapplered}111 us & \cellcolor{darktangerine}18 us\\ 
{} & 128 & 128 & 128 & \cellcolor{kellygreen}30 & 75 & \cellcolor{mediumcandyapplered}292 & \cellcolor{darktangerine}33 \\
{} & 256 & 256 & 256 & \cellcolor{kellygreen}42 & 104 & \cellcolor{mediumcandyapplered}456 & \cellcolor{darktangerine}46\\
{} & 512 & 512 & 512 & \cellcolor{darktangerine}76 & 300 & \cellcolor{mediumcandyapplered}729 & \cellcolor{kellygreen}65\\
\hline
\multirow{4}{6em}{\texttt{map f \\\hspace{1.5em}(m1 + m2)}} &
64 & 64 & --- & \cellcolor{kellygreen}37 us & 137 us & \cellcolor{mediumcandyapplered}202 us & ---\\ 
{} & 128 & 128 & --- & \cellcolor{kellygreen}105 & 397 & \cellcolor{mediumcandyapplered}579 & --- \\
{} & 256 & 256 & --- & \cellcolor{kellygreen}216 & 680 & \cellcolor{mediumcandyapplered}986 & ---\\
{} & 512 & 512 & --- & \cellcolor{kellygreen}273 & 900 & \cellcolor{mediumcandyapplered}1330 & ---\\
\hline
\multirow{4}{6em}{\texttt{map f \\\hspace{2em}(kron m1\\\hspace{4.5em} m2)}} &
2 & 64 & --- & \cellcolor{kellygreen}36 us & 94 us & \cellcolor{mediumcandyapplered}125 us & ---\\ 
{} & 2 & 128 & --- & \cellcolor{kellygreen}68 & 199 & \cellcolor{mediumcandyapplered}266 & --- \\
{} & 2 & 256 & --- & \cellcolor{kellygreen}126 & 449 & \cellcolor{mediumcandyapplered}636 & ---\\
{} & 4 & 128 & --- & \cellcolor{kellygreen}94 & 330 & \cellcolor{mediumcandyapplered}401 & ---\\
\hline
\end{tabular}

\end{table}

\footnotesize
\begin{itemize}
    \item C\texttt{++} --- SuiteSparse
    \vfill
    \item Сгенерированные аппаратные схемы оказываются хуже в смысле производительности, чем обе программные реализации\footnote{Несколько противоречит \url{https://dl.acm.org/doi/10.5555/2830840.2830850} }
    \vfill
    \item Для \texttt{mask m (m1 + m2)} реализация на Haskell с автоматическим fuision близка к реализации на C\texttt{++}
\end{itemize}

\end{frame}

\begin{frame}[fragile]\frametitle{Какие характеристики у сгенерированных аппаратных схем?}
\centering

\begin{table}[h]
\scriptsize
\centering
\begin{tabular}{|l|c|c|c|c|c|c|c|c|c|} 
\hline
\rowcolor{LightBlue}

{Функция} & \multicolumn{8}{c|}{Отношение (${\frac{FHW}{FHW_{distilled}}}$)} & {Частота}\\
\hline
{} & FDRE & LUT3 & LUT6 & LUT5 & LUT4 & LUT2 & RAMB36E2 & MUXF7 & {} \\
% \rowcolor{LightBlue}
\hline
\texttt{m1 + m2 + m3} & 0{,}3 & 0{,}3 & 0{,}3 & 0{,}5 & 0{,}3 & 0{,}3 & 0{,}5 & 0{,}5 & 200 МГц\\ 
\texttt{mask m (m1 + m2)} & 0{,}5 & 0{,}5 & 0{,}7 & 0{,}4 & 0{,}7 & 0{,}5 & 0{,}7 & 0{,}6 & 200 МГц\\
\texttt{map f (m1 + m2)} & 1 & 0{,}9 & 0{,}9 & 1{,}2 & 1 & 1{,}1 & 1{,}1 & 1{,}2 & 200 МГц\\
\texttt{map f (kron m1 m2)} & 1{,}5 & 1{,}5 & 1{,}3 & 2 & 2 & 1{,}8 & 1{,}4 & 1{,}7 & 200 МГц\\
\hline
\end{tabular}
\end{table}

\begin{itemize}
    \item Процент используемых ресурсов (кроме памяти) $< 1\%$
    \vfill
    \item Alveo U250 (на других чипах частота ниже, а процент ресурсов выше)
\end{itemize}

\end{frame}




% \begin{frame}[fragile]\frametitle{Сравнение дистиллированных и недистиллированных аппаратных схем}

% \centering
% \begin{tabular}{ |l|c|c|c|} 
% % \hline
% \rowcolor{LightBlue}
% {Function} & {time ratio} & {mem reads ratio} & {mem writes ratio}\\
% \hline
% \multirow{1}{10em}{\texttt{m1 + m2 + m3}} & 0.03 $\pm 0$ & 0.08 $\pm 0$ & 0.05 $\pm 0.01$\\
% \multirow{1}{10em}{\rowcolor{LightRed}\texttt{map f (m1 + m2)}} & 0.33 $\pm 0.03$ & 0.22 $\pm 0.02$ & 0.11 $\pm 0.01$\\
% \multirow{1}{10em}{\texttt{mask m (m1 + m2)}} & 0.15 $\pm 0.01$ & 0.2 $\pm 0.01$ & 0.09 $\pm 0$\\
% \multirow{1}{10em}{\rowcolor{LightRed}\texttt{map f (kron m1 m2)}} & 0.9 $\pm 0.01$ & 0.87 $\pm 0$ & 0.75 $\pm 0.01$\\
% \hline
% \end{tabular}

% \vfill

% \begin{itemize}

%     \item $ratio = \frac{P_{not\_distilled}}{P_{distilled}} - 1$
%     \vfill
%     \item Матрицы от 64x64 до 512x512 из Suite Sparse matrix collection
%     \vfill
%     \item Длина такта одинаковая --- 5 нс
% \end{itemize}

% \end{frame}


% \begin{frame}[fragile]\frametitle{Сравнение дистиллированной схемы и кода на Haskell}

% \centering
% \begin{tabular}{ |l|c|} 
% % \hline
% \rowcolor{LightBlue}
% {Function} & {time ratio}\\
% \hline
% \multirow{1}{10em}{\texttt{m1 + m2 + m3}} & 66 $\pm 13$\\
% \multirow{1}{10em}{\rowcolor{LightRed}\texttt{map f (m1 + m2)}} & 48 $\pm 15$\\
% \multirow{1}{10em}{\texttt{mask m (m1 + m2)}} & 140 $\pm 22$\\
% \multirow{1}{10em}{\rowcolor{LightRed}\texttt{map f (kron m1 m2)}} & 47 $\pm 58$\\
% \hline
% \end{tabular}

% \vfill

% \begin{itemize}

%     \item $ratio = \frac{P_{haskell}}{P_{distilled}} - 1$
%     \vfill
%     \item Матрицы от 64x64 до 512x512 из Suite Sparse matrix collection
%     \vfill
%     \item Длина такта одинаковая --- 5 нс
%     \vfill
%     \item \texttt{ghc -O2}
% \end{itemize}

% \end{frame}

% \begin{frame}{GHC 7.6.3}
%     \begin{itemize}
%         \item Используется GRIN фреймворк в качестве связующего звена между языком для дистиллятора и представления потока данных
%         \vfill
%         \begin{itemize}
%             \item Реализован транслятор с языка \texttt{.pot} в \texttt{.grin}
%         \end{itemize}
%         % We use GRIN framework as a middleware between frontend language of the distiller and dataflow backend
%         \vfill
%         \item Предоставляет дополнительные оптимизации
%         \vfill
%         \item CPS и дефункционализация выражаются проще
%         \vfill
%         \item \textcolor{codepurple}{В данный момент heap-points-to анализ в GRIN недостаточно производителен для наших примеров}
%     \end{itemize}
% \end{frame}


\begin{frame}{Результаты}
    \begin{itemize}
        % \item[\faCheck] Есть первые эксперименты
        \vfill
        \item[\faCheck] Изучены подходы к fusion в различных системах
        \vfill
        \item[\faCheck] Реализована генерация аппаратных схем с поддержкой fusion\footnote{\url{https://github.com/sedwards-lab/fhw}}
        \vfill
        \item[\faCheck] Реализована работа с памятью для схемы
        \vfill
        \item[\faCheck] Проведено экспериментальное исследование
        \vfill
        \begin{itemize}
            \item[\faCheck] Дистилляция успешно удаляет промежуточные структуры данных для выбранных примеров, сокращая до 2-ух раз число записей/чтений
            \vfill
            \item[\faCheck] Аппаратные реализации оказываются менее производительными, чем программные, но есть ещё пространство для улучшений в смысле параллелизма и конвейеризации
            \vfill
        \end{itemize}
        % \item[\faCheck] Работающий компилятор FHW \footnote{\url{https://github.com/sedwards-lab/fhw}}
        \vfill
        % \item[\faCheck] Поддержка GRIN для фронтенда\footnote{\url{https://github.com/Tiltedprogrammer/SparseLinAlgHardware}}
        % \vfill
        \item[\faCheck] Приняты доклады на ICFP 2021 SRC и VPT 2022
        % \vfill
        % \item[\faCheck] Дистилляция успешно удаляет промежуточные структуры данных для выбранных примеров, сокращая до 2-ух раз число записей/чтений
        % \vfill
        % \item[\faCheck] Высокоуровневый синтез внушает оптимизм
        % \vfill
        % \item[\faComment] Сравниться на референсных матрицах со SuiteSparse
        % \vfill
        % \item[\faComment] \textcolor{codepurple}{Есть ещё потенциал в смысле параллелизма для FHW (уйти от CPS, поэкспериментировать с различными реализациями памяти)}
        % \vfill
        % \item[\faComment] \textcolor{codepurple}{Сравниться с Reduceron и подобными проектами}
        
    \end{itemize}
\end{frame}

\appendix


\begin{frame}[fragile]\frametitle{Даёт ли дистилляция преимущества на программном и аппаратном уровнях?}

\setbeamertemplate{caption}{\insertcaption}

\centering
\begin{table}[h]
\scriptsize
\begin{minipage}{0.45\linewidth}
\centering
\caption{\texttt{m1 + m2 + m3}}
\begin{tabular}{|c|c|c|c|c|c|c|} 
\hline
\rowcolor{LightBlue}
\multicolumn{3}{|c|}{Размеры матриц} & \multicolumn{2}{c|}{Отношение ($\frac{FHW}{FHW_{distilled}}$)}\\
\hline
m1 & m2 & m3 & запси & чтения\\ 
\hline
64 & 64 & 64 & 1{,}10 & 1{,}15\\ 
128 & 128 & 128 & 1{,}02 & 1{,}05\\
256 & 256 & 256 & 1{,}03 & 1{,}06\\
512 & 512 & 512 & 1{,}10 & 1{,}16\\
\hline
\end{tabular}
\end{minipage}
\begin{minipage}{0.45\linewidth}
\centering
\caption{\texttt{mask m (m1 + m2)}}
\begin{tabular}{|c|c|c|c|c|c|c|} 
\hline
\rowcolor{LightBlue}
\multicolumn{3}{|c|}{Размеры матриц} & \multicolumn{2}{c|}{Отношение ($\frac{FHW}{FHW_{distilled}}$)}\\
\hline
m1 & m2 & m3 & записи & чтения\\ 
\hline
64 & 64 & 64 & 1{,}13 & 1{,}26\\ 
128 & 128 & 128 & 1{,}06 & 1{,}11\\
256 & 256 & 256 & 1{,}08 & 1{,}09\\
512 & 512 & 512 & 1{,}10 & 1{,}16\\
\hline
\end{tabular}
\end{minipage}
\vfill
\begin{minipage}{0.45\linewidth}
\centering
\caption{\texttt{map f (m1 + m2)}}
\begin{tabular}{|c|c|c|c|c|c|c|} 
\hline
\rowcolor{LightBlue}
\multicolumn{3}{|c|}{Размеры матриц} & \multicolumn{2}{c|}{Отношение ($\frac{FHW}{FHW_{distilled}}$)}\\
% \rowcolor{LightBlue}
\hline
m1 & m2 & m3 & записи & чтения\\ 
\hline
64 & 64 & --- & 1{,}10 & 1{,}21\\ 
128 & 128 & --- & 1{,}07 & 1{,}14\\
256 & 256 & --- & 1{,}07 & 1{,}19\\
512 & 512 & --- & 1{,}10 & 1{,}21\\
\hline
\end{tabular}
\end{minipage}
\begin{minipage}{0.45\linewidth}
\centering
\caption{\texttt{map f (kron m1 m2)}}
\begin{tabular}{|c|c|c|c|c|c|c|} 
\hline
\rowcolor{LightBlue}
\multicolumn{3}{|c|}{Размеры матриц} & \multicolumn{2}{c|}{Отношение ($\frac{FHW}{FHW_{distilled}}$)}\\
% \rowcolor{LightBlue}
\hline
m1 & m2 & m3 & записи & чтения\\ 
\hline
2 & 64 & --- & 1{,}71 & 1{,}88\\ 
2 & 128 & --- & 1{,}72 & 1{,}87\\
2 & 256 & --- & 1{,}65 & 1{,}83\\
4 & 128 & --- & 1{,}81 & 1{,}91\\
\hline
\end{tabular}
\end{minipage}

\end{table}
\end{frame}


\end{document}